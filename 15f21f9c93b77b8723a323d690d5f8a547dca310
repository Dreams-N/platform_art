Revision: 15f21f9c93b77b8723a323d690d5f8a547dca310
Patch-set: 4
File: runtime/interpreter/interpreter_goto_table_impl.cc

199:0-203:43
Tue Jan 26 12:02:42 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 34b68e05_1cec75b0
Bytes: 314
This dance (repeated in the other interpreter implementations) is annoying. It's a shame we create all the ifnrastructure for starting running with the interpreter and then decide that we actually want to JIT and discard everything.

Could you try moving this earlier, before the creation of the interpreter state?

199:0-203:43
Tue Jan 26 15:27:59 2016 +0000
Author: David Srbecky <1065473@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 34b68e05_1cec75b0
UUID: 14b18a0d_9b2c0b87
Bytes: 500
I would really like to avoid going into the interpreter if possible, but presumably we can not avoid it.
We set the flags when the Zygote is forked and the code might already be in the interpreter.
We will also get into the interpreter if the code can not be compiled.
Either way, we need something in the interpreter to exit it.

Having said that, there might be other places in the interpreter to do this, but this place might be as good as any. (and we have already done the dance with testing it)

199:0-203:43
Tue Jan 26 15:41:00 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 14b18a0d_9b2c0b87
UUID: 74ac86b5_1e7fcd3d
Bytes: 765
> I would really like to avoid going into the interpreter if
 > possible, but presumably we can not avoid it.
 > We set the flags when the Zygote is forked and the code might
 > already be in the interpreter.

Sure, but you check whether you need to run into jit if the dex_pc is 0, so existing threads in the interpreter will stay in the interpreter.

What I'm asking for is an earlier place where we check if the JIT is set for first use.

 > We will also get into the interpreter if the code can not be
 > compiled.
 > Either way, we need something in the interpreter to exit it.
 > 
 > Having said that, there might be other places in the interpreter to
 > do this, but this place might be as good as any. (and we have
 > already done the dance with testing it)

File: runtime/interpreter/interpreter_switch_impl.cc

101:14-101:15
Tue Jan 26 12:02:42 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: b4a27ebd_40068e37
Bytes: 9
misplaced

File: runtime/jit/jit.cc

206:28-206:34
Tue Jan 26 12:02:42 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: b4a27ebd_20038a27
Bytes: 36
I think you don't need this anymore.

206:28-206:34
Tue Jan 26 15:27:59 2016 +0000
Author: David Srbecky <1065473@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: b4a27ebd_20038a27
UUID: 34b68e05_dc3f2d91
Bytes: 56
Done (std::unique_ptr overloads it, I did not know that)

File: runtime/jit/jit_instrumentation.cc

165:6-165:65
Tue Jan 26 12:02:42 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 54a782d1_7d6a57f3
Bytes: 25
GetJit()->JitAtFirstUse()

165:6-165:65
Tue Jan 26 15:27:59 2016 +0000
Author: David Srbecky <1065473@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 54a782d1_7d6a57f3
UUID: b4a27ebd_4039eea7
Bytes: 4
Done

166:0-169:5
Tue Jan 26 12:02:42 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 94a57ac9_5f942b04
Bytes: 105
Drop the logging, just create it and comment that's because the compiler requires a ProfilingInfo object.

166:0-169:5
Tue Jan 26 15:27:59 2016 +0000
Author: David Srbecky <1065473@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 94a57ac9_5f942b04
UUID: b4a27ebd_2036eab7
Bytes: 4
Done

File: runtime/native/dalvik_system_ZygoteHooks.cc

115:0-115:35
Tue Jan 26 12:02:42 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: d4c4527f_19612b11
Bytes: 88
Should you log fatal if that's not the case? Blindly continuing is not helping the user.

115:0-115:35
Tue Jan 26 15:27:59 2016 +0000
Author: David Srbecky <1065473@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: d4c4527f_19612b11
UUID: 14b18a0d_3b1cd753
Bytes: 62
Done.  As far as I can tell GetJITOptions are always non-null.

