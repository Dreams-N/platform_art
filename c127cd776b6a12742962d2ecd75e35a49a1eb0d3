Revision: c127cd776b6a12742962d2ecd75e35a49a1eb0d3
Patch-set: 2
File: compiler/optimizing/intrinsics_x86.cc

1771:6-1771:36
Fri Aug 14 03:15:35 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 043dc1ed_08ca2bb2
Bytes: 256
Isn't this incorrect wrt/ int vs long?

I checked the test (082), and I think an issue is that we don't test any non-zero constant. Please add test coverage and show whether this is right (I don't think so, you'd count too many zeros for is_long == false).

1771:6-1771:36
Fri Aug 14 03:16:51 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 043dc1ed_08ca2bb2
UUID: e4aeed64_4cb67379
Bytes: 28
Also: use bit_utils.h:CLZ...

1771:6-1771:36
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e4aeed64_4cb67379
UUID: e4aeed64_8fe69d22
Bytes: 4
Done

1773:4-1773:34
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 040b0162_cfb67dc0
Bytes: 43
Use

  __ xorl(out, out);

when value == 0?

1779:4-1784:5
Fri Aug 14 03:29:46 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 043dc1ed_68949798
Bytes: 358
Hm, spec says the result is undefined if the source operand has value 0. Doesn't that mean you'll have to have a check for that (in case it's not a constant but still zero), i.e., check zf after?

(Guess this also requires some test coverage.)

Also, ever want to add optional support for lzcnt which would take care of this (including the correction below)?

1779:4-1784:5
Fri Aug 14 13:14:27 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 043dc1ed_68949798
UUID: c43e49ec_236c6e26
Bytes: 370
I didn't want to implement lzcnt, as I don't believe our target machines support it, so it wasn't worth adding as a feature at this time.  It could be added later.

I got the sequences from GCC compiled code for int and long in 32 and 64 bit.  It surprised me as well, but I guess the undefined behaviour actually gives a reasonable result that can be used with the xor.

1779:4-1784:5
Fri Aug 14 15:09:12 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: c43e49ec_236c6e26
UUID: a4fb1585_ac50632b
Bytes: 171
No, the difference is that the __builtin_clz spec says that the result is undefined if you give zero. Java, however, clearly specifies 32 as the return value in this case.

1779:4-1784:5
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a4fb1585_ac50632b
UUID: 64591d73_c3501c2d
Bytes: 4
Done

1787:27-1787:46
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: a466b534_1473748f
Bytes: 29
Nit:

  zero_value_result - 1

1799:2-1799:21
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: c4672930_d568dc96
Bytes: 42
Nit: move this earlier, e.g. on line 1796.

1800:16-1800:22
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 24080563_d0da9cde
Bytes: 16
Nit: handle_low?

1809:2-1809:23
Fri Aug 14 10:37:46 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: a466b534_f415184a
Bytes: 30
out is undefined if ZF is set.

1809:2-1809:23
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a466b534_f415184a
UUID: 04b861a5_90f0fa05
Bytes: 4
Done

1810:0-1811:30
Fri Aug 14 10:37:46 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: c4672930_b50ba02f
Bytes: 28
__ xorl(out, Immediate(63));

1810:0-1811:30
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: c4672930_b50ba02f
UUID: a4a8755c_4db67179
Bytes: 64
No, we want 32 + CLZ(low). That is not the same as CLZ(low) ^ 63

1810:0-1811:30
Fri Aug 14 16:06:26 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a4a8755c_4db67179
UUID: 0456a145_b79288d9
Bytes: 181
Did you misread my comment? It's about replacing _two_ lines, not just the last one.

For every x in [0, 31], 32+(x^31) = x^63, i.e.

   32+CLZ(low) = 32+BSR(low)^31 = BSR(low)^63 .

1810:0-1811:30
Fri Aug 14 16:19:18 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 0456a145_b79288d9
UUID: a4a8755c_4d03d185
Bytes: 134
Sorry.  I had mis-computed my answer when calculating it by hand because I was using CLZ, not BSR, and thought it wasn't right.

Done.

1818:45-1818:50
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e4f18da3_0ea40b37
Bytes: 19
/* is_long */ false

1822:28-1822:44
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: a466b534_f4923828
Bytes: 9
down_cast

1823
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 4401793c_f1924828
Bytes: 23
Nit: remove blank line.

1824:37-1824:42
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 040b0162_8fac7574
Bytes: 19
/* is_long */ false

1828:45-1828:49
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 0456a145_d7257c5f
Bytes: 18
/* is_long */ true

1832:28-1832:44
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 4401793c_b198c04a
Bytes: 9
down_cast

1833
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e46c2d17_d657449f
Bytes: 23
Nit: remove blank line.

1834:37-1834:41
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: c4ec89d0_adbdfdaf
Bytes: 18
/* is_long */ true

File: compiler/optimizing/intrinsics_x86_64.cc

1612:7-1612:13
Fri Aug 14 10:37:46 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e4f18da3_0e5c0bf8
Bytes: 8
Evaluate

1612:7-1612:13
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e4f18da3_0e5c0bf8
UUID: 243ac5f6_46126618
Bytes: 4
Done

1617:14-1617:35
Fri Aug 14 10:37:46 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: a466b534_94082434
Bytes: 79
is_long ? CLZ(static_cast<uint64_t>(value)) : CLZ(static_cast<uint32_t>(value))

1617:14-1617:35
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a466b534_94082434
UUID: 243ac5f6_26176208
Bytes: 4
Done

1619:4-1619:35
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e46c2d17_1636dc6e
Bytes: 43
Use

  __ xorl(out, out);

when value == 0?

1638:0-1639:47
Fri Aug 14 10:37:46 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: c4672930_7502a818
Bytes: 143
You need to do much more than this. The manual says

  IF SRC = 0
     THEN
         ZF <- 1
         DEST is undefined;
     ELSE
         ...

1638:0-1639:47
Fri Aug 14 15:46:23 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: c4672930_7502a818
UUID: e4aeed64_0f25cde2
Bytes: 4
Done

1639:25-1639:44
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e46c2d17_b64448d2
Bytes: 29
Nit:

  zero_value_result - 1

1649:37-1649:42
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 040b0162_4f560dda
Bytes: 19
/* is_long */ false

1659:37-1659:41
Fri Aug 14 16:24:45 2015 +0000
Author: Roland Levillain <1052644@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: c4672930_15eed47f
Bytes: 18
/* is_long */ true

File: compiler/utils/x86_64/assembler_x86_64_test.cc

1152:80-1152:84
Fri Aug 14 10:37:46 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 4401793c_31f85089
Bytes: 4
bsrq

