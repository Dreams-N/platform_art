Revision: ece9ab2058dcee58fb188083c81f5a64d5da0f09
Patch-set: 2
File: compiler/utils/x86/assembler_x86.cc

1809:0-1810:27
Wed Aug 26 09:33:33 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 44e3394a_4a6827e8
Bytes: 20
Restore indentation.

1809:0-1810:27
Wed Aug 26 12:36:30 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 44e3394a_4a6827e8
UUID: 048f817d_4adec952
Bytes: 4
Done

File: compiler/utils/x86/assembler_x86.h

206:6-206:16
Wed Aug 26 09:33:33 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e45eedce_4961057c
Bytes: 83
I think NearLabel would be a better name (we had that for Thumb2 for a short time).

206:6-206:16
Wed Aug 26 12:36:30 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e45eedce_4961057c
UUID: c42ba915_89693b9b
Bytes: 4
Done

234:0-236:40
Wed Aug 26 09:33:33 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: c459e9e9_4be7b9d1
Bytes: 280
With delta encoding that one byte should be enough - the oldest link cannot be more than 127 bytes away.

Then we don't really need a re-implementation of Label. Maybe it should just privately derive from the generic Label and make stuff visible with using-declarations as needed.

234:0-236:40
Wed Aug 26 12:36:30 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: c459e9e9_4be7b9d1
UUID: a47f9520_2da4bb36
Bytes: 137
We need the bigger size to be able to CHECK that we haven't exceeded the maximum offset allowed.

Encoding size or correctness?
Comments?

234:0-236:40
Wed Aug 26 12:59:05 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a47f9520_2da4bb36
UUID: c459e9e9_6b5f15f2
Bytes: 569
The loop in Bind() could be

  while (label->IsLinked()) {
    int position = label->LinkPosition();
    uint8_t delta = buffer_.Load<uint8_t>(position);
    int offset = bound - (position + 1);
    CHECK(IsInt<8>(offset));
    buffer_.Store<int8_t>(position, offset);
    label->position_ = delta != 0u ? label->position_ - delta : 0;
  }

And you can CHECK() that delta is small enough as you calculate it in EmitLabelLink().

This would be just a minor modification of the old approach.

(Having the vector is more readable, of course, but the compile time suffers.)

File: compiler/utils/x86/assembler_x86_test.cc

265:25-265:31
Wed Aug 26 09:33:33 2015 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 44e3394a_2a65e30f
Bytes: 59
Can you test 2 froward branches to the same target, please?

265:25-265:31
Wed Aug 26 12:36:30 2015 +0000
Author: Mark P Mendell <1036869@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 44e3394a_2a65e30f
UUID: c42ba915_2957c7d8
Bytes: 4
Done

