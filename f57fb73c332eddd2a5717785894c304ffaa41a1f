Revision: f57fb73c332eddd2a5717785894c304ffaa41a1f
Patch-set: 1
File: runtime/arch/arm64/quick_entrypoints_arm64.S

1016:4-1016:7
Thu May 08 11:15:04 2014 +0000
Author: Zheng Xu <1042649@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 8afd1475_66517695
Bytes: 33
I don't think it will be changed.

1017:4-1017:8
Thu May 08 11:15:04 2014 +0000
Author: Zheng Xu <1042649@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 8afd1475_e60726a3
Bytes: 50
ldaxr  w1, [x4]    // load lock_word, acquire lock

1019:4-1019:8
Thu May 08 11:15:04 2014 +0000
Author: Zheng Xu <1042649@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 8afd1475_26476edc
Bytes: 55
stlxr  w3, w2, [x4]    // store lock_word, release lock

1019:4-1019:8
Thu May 08 22:19:18 2014 +0000
Author: Hans Boehm <1042828@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 8afd1475_26476edc
UUID: ca138c9f_d3829eeb
Bytes: 330
This doesn't need to be a release store.  See F.3.1 in the ARMv8 manual.

So long as the ldx uses acquire, the barrier can be dropped and nothing else is needed.  I'd vote for moving everything from dmb to acquire/release in one fell swoop, since the documentation seems less than crystal clear on acquire/release/dmb interaction.

1021:0-1021:94
Wed May 07 00:06:04 2014 +0000
Author: Ian Rogers <1010118@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: aa49f8a5_c49cb48e
Bytes: 23
dmb ishld ? (new in v8)

1066:11-1066:14
Wed May 07 00:06:04 2014 +0000
Author: Ian Rogers <1010118@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 8a58b470_40ffe2d0
Bytes: 6
ishst?

1066:11-1066:14
Wed May 07 01:03:07 2014 +0000
Author: Hans Boehm <1042828@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 8a58b470_40ffe2d0
UUID: 8a58b470_00a84afe
Bytes: 784
This needs to be a LoadStore and StoreStore barrier.  Andreas and I concluded form the table in the documentation that ish is probably the best we can do here.

Much more importantly, the barrier needs to go BEFORE the stores that effects the release of the lock.  Otherwise memory operations inside the critical sections can become visible after the lock release becomes effective, allowing other threads to acquire the lock before they see changes performed by this critical section.

If the same code is used for ARM32, it should be fixed there, too.

I conjecture that just replacing the str with an strl, removing the dmb, will work as well and run faster.  The documentation is not as clear as I would personally like about the interaction of acquire/release operations and dmb.

File: runtime/arch/x86_64/quick_entrypoints_x86_64.S

700:0-700:34
Wed May 07 00:06:04 2014 +0000
Author: Ian Rogers <1010118@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 6a346007_e9b0971d
Bytes: 94
was this a copy of old code brought over from x86? I remember there was a similar issue there.

