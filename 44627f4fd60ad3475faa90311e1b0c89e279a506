Revision: 44627f4fd60ad3475faa90311e1b0c89e279a506
Patch-set: 11
File: runtime/interpreter/interpreter_goto_table_impl.cc

2557
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 504861a0_24691374
Bytes: 180
What is it supposed to throw then?

  throw OldException(MonitorException)

or

  throw MonitorException(OldException)

or just 

  throw MonitorException //discard OldException

?

2557
Thu Oct 08 18:31:14 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 504861a0_24691374
UUID: 90673931_b7b0bb6c
Bytes: 13
The last one.

2557
Thu Oct 08 18:46:55 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 90673931_b7b0bb6c
UUID: 5061411e_50ae8d0a
Bytes: 291
Ok, do you think it would make sense to add that in a comment somewhere?

  // Potentially throws a MonitorStateException, clearing the previous exception

Although it's pretty easy to get to now by just looking in the .cc file for LockCountData, so maybe people can just look at the source.

2557
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5061411e_50ae8d0a
UUID: 451b415b_462214bc
Bytes: 134
I'd rather not repeat the comment on the declaration, if possible. The "Check" in the name hopefully tells enough about the exception.

File: runtime/stack.cc

1088
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 90673931_375dcb0b
Bytes: 190
Agreed, this should wrap either as a suppressed exception so that we don't lose the original one.

(looks like IllegalMonitorStateException doesn't have an (Exception) constructor, too bad).

1088
Thu Oct 08 18:31:14 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 90673931_375dcb0b
UUID: 90673931_571e8701
Bytes: 329
1) The constructor would be the wrong way (that is the cause, not the suppressed exception).

2) The definition isn't clear (it never is with suppressed exceptions).

3) Suppressed exceptions are a lot of work to get right. I think for simplicity it's enough to tell people they screwed up with locks, as it should not be common.

1099
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: d00a915c_5b888661
Bytes: 44
DCHECK obj not null?

Why does it need self?

1099
Thu Oct 08 18:31:14 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: d00a915c_5b888661
UUID: 90673931_97281f25
Bytes: 49
Because I don't want to put in Thread::Current().

File: runtime/stack.h

78
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 30592d74_158d23bb
Bytes: 56
nit: public functions should have comments, as per style

78
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 30592d74_158d23bb
UUID: eaf16251_60bd9214
Bytes: 4
Done

80
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 504861a0_64c03bb3
Bytes: 45
can obj be const?
DCHECK for self being null?

80
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 504861a0_64c03bb3
UUID: e55355fb_93e51ec2
Bytes: 76
Doesn't make sense. It goes into the vector, which is mutable because of GC.

80
Fri Oct 09 01:34:13 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e55355fb_93e51ec2
UUID: 0536a9c7_4cf5cfae
Bytes: 135
I was suggesting changing it to a "pointer-to-const" and not "const-pointer-to-something"

So the GC can still manipulate it just fine.

80
Fri Oct 09 03:49:03 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 0536a9c7_4cf5cfae
UUID: 8521b987_2be87ddb
Bytes: 103
The visitors are also free to modify the content of the objects. So I don't think that's right, either.

88
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 5061411e_75cf3be0
Bytes: 54
nit: DCHECK arguments for not null?

can obj be const?

88
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5061411e_75cf3be0
UUID: 0536a9c7_89eed92b
Bytes: 123
obj can be const (with a const-cast for error printing, which I think is OK), we handle null internally. self shouldn't be.

92
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 504861a0_84a8e7fb
Bytes: 320
So apparently this can throw but nothing mentions that, I was under the impression the existing interpreter convention was

   bool FunctionNameOrThrow(args)

and it would return false and set the exception, otherwise return true.

Also Nicolas has remarked in the past that the name/comment should mention if it throws.

92
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 504861a0_84a8e7fb
UUID: 8538d9b1_50dad246
Bytes: 349
There are many functions in the interpreter that do *not* follow this, so I feel I haven't violated anything. Especially the call-site of this doesn't follow the convention.

I'll change the name, but I don't think the return type is valuable if the call site is written in a different way (as are a lot of bytecode parts that may or may not throw).

92
Fri Oct 09 01:34:13 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 8538d9b1_50dad246
UUID: 054dc959_54bd629f
Bytes: 397
Would slightly prefer being consistent with the "bool" over the "void" because the void doesn't tell us anything.

If anything the existing interpreter functions that *do* return void should be flipped to bool in a potential cleanup.

Also just consider the performance point of view, it's faster to unwind by checking the return value of a function then to check if there was a pending exception.

104
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 704d65ae_037e8d6d
Bytes: 25
should probably be Args&&

104
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 704d65ae_037e8d6d
UUID: e55355fb_b3ea228f
Bytes: 4
Done

106
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 5061411e_15bec73e
Bytes: 27
std::forward<Args>(args)...

106
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5061411e_15bec73e
UUID: 054dc959_540c827a
Bytes: 4
Done

118
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: d00a915c_fbe69a4b
Bytes: 91
IIRC Mathieu was asking for a comment earlier explaining why they weren't used with GcRoots

118
Thu Oct 08 18:31:14 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: d00a915c_fbe69a4b
UUID: 105c2963_0eba37aa
Bytes: 40
The comment is in the class description.

118
Thu Oct 08 18:46:55 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 105c2963_0eba37aa
UUID: d03c51f4_48226eef
Bytes: 81
Oh, I see it now. Perhaps it might be slightly better if it was here instead :) ?

118
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: d03c51f4_48226eef
UUID: 8538d9b1_b02216ee
Bytes: 4
Done

328
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 5061411e_d531ef91
Bytes: 102
nit: This could just be LockCountData& GetLockCountData(), so the call site doesn't have to null check

328
Thu Oct 08 18:31:14 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5061411e_d531ef91
UUID: 5061411e_300dd104
Bytes: 92
We modify the data, so it must be a non-const ref, and I thought we're still averse to that?

328
Thu Oct 08 18:46:55 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5061411e_300dd104
UUID: 30592d74_b0df25ea
Bytes: 287
No, we're not averse to that currently, and we never were because it's not a parameter.

Some people might disagree, in which case it should at least say "// Returns a not-null pointer to..."

but my personal philosophy is why repeat something in a comment obvious from the signature? :)

328
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 30592d74_b0df25ea
UUID: eaf16251_80a1b6ee
Bytes: 4
Done

File: test/088-monitor-verification/src/Main.java

72
Thu Oct 08 17:50:08 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 1001893d_26c5acc2
Bytes: 18
What does that do?

72
Thu Oct 08 18:31:14 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 1001893d_26c5acc2
UUID: b0435d80_2890c4d5
Bytes: 122
What it states in the name. If asserts aren't disabled, it will check that the call-site is managed code, not interpreted.

72
Thu Oct 08 18:46:55 2015 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: b0435d80_2890c4d5
UUID: 5061411e_10bb754e
Bytes: 268
Oh, that was confusing to me because "managed" just usually means anything not native (i.e. any executed java code is managed code). Perhaps there is a terminology in Art I'm not familiar with yet.

Alternatively, this could be "assertIsCompiled" to be less ambiguous.

72
Fri Oct 09 01:21:04 2015 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5061411e_10bb754e
UUID: a526bd9a_c9dff5e7
Bytes: 57
A follow-up maybe, this is shared between multiple tests.

